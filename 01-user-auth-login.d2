direction: down

start: 开始
start.shape: oval
start.style.fill: "#dff7f3"

input_cred: 输入用户名密码
input_cred.shape: parallelogram
input_cred.style.fill: "#e7f8ec"

call_login: POST /user/login
call_login.shape: parallelogram
call_login.style.fill: "#e7f8ec"

save_state: 写入 Pinia(token/role/userId/username)
save_state.style.fill: "#e8f1ff"

next_req: 后续请求自动带 JWT
next_req.style.fill: "#e8f1ff"

end_ok: 登录后进入系统
end_ok.shape: oval
end_ok.style.fill: "#dff7f3"

end_fail: 结束(未登录)
end_fail.shape: oval
end_fail.style.fill: "#dff7f3"

check_user: 校验用户名存在
check_user.shape: diamond
check_user.style.fill: "#fff1dc"

verify_pwd: 校验密码哈希(md5+salt)
verify_pwd.shape: diamond
verify_pwd.style.fill: "#fff1dc"

gen_jwt: 生成JWT(id, role)
gen_jwt.style.fill: "#e8f1ff"

login_resp_ok: 返回 success=true + token
login_resp_ok.shape: parallelogram
login_resp_ok.style.fill: "#e7f8ec"

login_resp_fail: 返回 success=false(msg)
login_resp_fail.shape: parallelogram
login_resp_fail.style.fill: "#ffe8e8"

auth_ok: JWT是否有效或访问无需登录的接口
auth_ok.shape: diamond
auth_ok.style.fill: "#fff1dc"

admin_forbidden: 是否访问/admin且非管理员
admin_forbidden.shape: diamond
admin_forbidden.style.fill: "#fff1dc"

allow_handler: 放行业务处理
allow_handler.style.fill: "#e8f1ff"

reject_401: 返回401未授权
reject_401.style.fill: "#ffe8e8"

reject_403: 返回403无权限
reject_403.style.fill: "#ffe8e8"

user_table: user表(用户名/密码哈希/角色)
user_table.shape: cylinder
user_table.style.fill: "#e7f8ec"

start -> input_cred -> call_login
call_login -> check_user
check_user -> user_table: 查询用户
check_user -> login_resp_fail: 否
check_user -> verify_pwd: 是
verify_pwd -> login_resp_fail: 否
verify_pwd -> gen_jwt: 是
gen_jwt -> login_resp_ok

login_resp_ok -> save_state -> next_req
login_resp_fail -> end_fail

next_req -> auth_ok
auth_ok -> reject_401: 否
auth_ok -> admin_forbidden: 是

admin_forbidden -> reject_403: 是
admin_forbidden -> allow_handler: 否

allow_handler -> end_ok
reject_401 -> end_fail
reject_403 -> end_fail

admin_forbidden.shape: rectangle
admin_forbidden.style.fill: "#ffe8e8"
allow_handler.shape: rectangle
gen_jwt.shape: rectangle
login_resp_fail.shape: rectangle
next_req.shape: parallelogram
next_req.style.fill: "#e7f8ec"
reject_401.shape: rectangle
reject_403.shape: rectangle
save_state.shape: rectangle
user_table.style.fill: "#eef5e9"
